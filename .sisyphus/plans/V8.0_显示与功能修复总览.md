# LiuMo V8.0 显示与功能修复方案

## 📋 项目概述

**目标**: 修复V8.0重构后的4个核心问题,在保留新架构优势的前提下恢复完整的显示效果和设置功能

**原则**:
- ✅ 保留V8.0架构(策略模式布局引擎、虚拟滚动、新数据结构)
- ✅ 恢复画布显示效果(朱砂红分隔线、字格对齐、合适的尺寸)
- ✅ 修复设置功能(横竖排、字格样式等真正生效)
- ✅ 删除智能吸附(新版有布局策略自动检测)

---

## 🎯 问题诊断总结

| Issue | 根本原因 | 影响范围 |
|-------|---------|---------|
| **1. 画布无智能感知,小窗口遮挡** | PaperCanvas仅监听高度,布局引擎使用硬编码columns/gridSize,未实现容器宽度→列数的动态计算 | 所有窗口尺寸调整场景 |
| **2. 设置功能不生效** | watchEffect是空壳,ConfigStore与LayoutEngine完全断连,设置修改不触发重布局 | 横竖排、字格样式、边框模式等所有设置 |
| **3. 分隔线未精准分隔** | 缺少V1.5.5的"背景透色"机制(朱砂红背景+gap透出),且borderMode='lines-only'未在策略中处理 | 分隔线显示效果 |
| **4. 字格不对齐** | gridSize=40但CharacterCell默认96,fontSize=32但实际渲染时尺寸失配,字格SVG与文字位置游离 | 所有字格显示 |

---

## 📅 实施计划

### 时间估算
- **总工时**: 约15.5小时 (2个工作日)
- **并行可能性**: 阶段3与阶段4可部分并行

### 阶段划分

| 阶段 | 优先级 | 任务数 | 预计时间 | 依赖关系 |
|------|--------|--------|----------|----------|
| [阶段1: 核心连接层修复](./阶段1_核心连接层修复.md) | P0 Critical | 3 | 7小时 | 无依赖,可独立进行 |
| [阶段2: 视觉效果恢复](./阶段2_视觉效果恢复.md) | P1 High | 2 | 3小时 | 依赖阶段1完成 |
| [阶段3: 横竖排功能实现](./阶段3_横竖排功能实现.md) | P2 Medium | 2 | 4小时 | 依赖阶段1完成 |
| [阶段4: 清理优化](./阶段4_清理优化.md) | P3 Low | 2 | 1.5小时 | 可与阶段3并行 |

---

## ✅ 验收标准

修复完成后应满足:

- ✅ 调整窗口宽度时,列数自动调整,不出现横向滚动条(除非内容超宽)
- ✅ 设置面板的所有开关(横竖排、RTL、边框模式、字格样式)立即生效
- ✅ borderMode='lines-only'时显示朱砂红分隔线,无字格
- ✅ borderMode='full'时显示字格+分隔线
- ✅ 字格与文字完美对齐,字体居中占格子约60-70%
- ✅ 竖排模式下,从右向左排列(RTL),滚动条初始在右侧
- ✅ 固定行列功能正常(禁用时走自适应)
- ✅ 无TypeScript类型错误
- ✅ 无控制台运行时错误

---

## 📂 文档结构

```
.sisyphus/plans/
├── V8.0_显示与功能修复总览.md     (本文档)
├── 阶段1_核心连接层修复.md          (7小时 - P0)
├── 阶段2_视觉效果恢复.md            (3小时 - P1)
├── 阶段3_横竖排功能实现.md          (4小时 - P2)
└── 阶段4_清理优化.md                (1.5小时 - P3)
```

每个阶段文档包含:
- 任务目标
- 详细文件修改清单(含代码示例)
- 验证步骤
- 完成标准

---

## 🚀 执行建议

### 推荐执行顺序
1. **先完成阶段1** - 这是基础,所有其他阶段都依赖它
2. **验证阶段1效果** - 确认设置同步和响应式工作正常
3. **并行执行阶段2和阶段3** - 可以分配给不同开发者
4. **最后执行阶段4** - 清理和优化

### 测试策略
- 每个阶段完成后立即测试
- 不要等到全部完成才测试
- 使用多种窗口尺寸测试响应式
- 测试所有设置选项的组合

### 风险点
- **阶段1的watchEffect**: 确保响应式链路完整,避免循环依赖
- **尺寸体系统一**: 所有地方都要使用96,不能有遗漏的硬编码
- **竖排实现复杂度**: 坐标转换逻辑容易出错,需要仔细测试

---

## 📞 支持与反馈

执行过程中如遇问题:
1. 检查对应阶段文档的验证步骤
2. 使用浏览器DevTools检查DOM结构和样式
3. 在关键函数入口添加console.log或断点
4. 对比V1.5.5的git历史代码(git show v1.5.5:path/to/file)

---

**文档版本**: 1.0  
**创建日期**: 2026-01-31  
**预计完成日期**: 2026-02-02
