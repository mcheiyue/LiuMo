# 阶段3: 横竖排功能实现

**优先级**: 🟡 P2 Medium  
**预计耗时**: 4小时  
**目标**: 在布局引擎中真正实现竖排逻辑，支持 RTL (从右向左) 排列。

---

## 任务清单

### 3.1 gridStrategy 支持竖排 (3小时)
**目标**: 修改核心布局算法，支持 y 轴为主轴（行内），x 轴为交叉轴（换行）。

**修改文件**:

**1️⃣ `src/utils/layoutEngine/strategies/gridStrategy.ts`**

重构 `calculateGridLayout` 函数：

```typescript
export function calculateGridLayout(content, config): LayoutResult {
  const { isVertical, gridSize, gap = 3, paddingLeft, paddingTop, columns, maxRows } = config;
  const cellWithGap = gridSize + gap;
  const items: LayoutItem[] = [];
  
  let row = 0;
  let col = 0;
  
  // ... 遍历逻辑 ...

  if (isVertical) {
    // 竖排逻辑
    // x 轴方向是列（col），y 轴方向是字（row）
    const x = paddingLeft + col * cellWithGap;
    const y = paddingTop + row * cellWithGap;
    
    items.push({ char, x, y, ... });
    
    // 换行逻辑：字向下排，满行后换列
    row++;
    // 如果设置了固定行数(maxRows)则使用，否则根据高度动态计算
    const limitRow = maxRows || 20; 
    if (row >= limitRow) {
      row = 0;
      col++;
    }
  } else {
    // 横排逻辑 (保持现有，确保加上 gap)
    const x = paddingLeft + col * cellWithGap;
    const y = paddingTop + row * cellWithGap;
    
    items.push({ char, x, y, ... });
    
    col++;
    if (col >= columns) {
      col = 0;
      row++;
    }
  }
  
  // ... 计算 totalWidth/totalHeight
}
```

---

### 3.2 实现 RTL 列序 (1小时)
**目标**: 竖排模式下，实现从右向左的古籍排版习惯。

**修改文件**:

**1️⃣ `src/utils/layoutEngine/strategies/gridStrategy.ts`**
在计算 x 坐标时加入 RTL 逻辑：

```typescript
// 计算总列数（需要预先知道或在后处理中修正）
// 简单方案：先按 LTR 计算，最后统一翻转 x 坐标

// 方案 A: 后处理翻转 (推荐)
const totalCalculatedCols = col + 1; // 实际使用的总列数

if (isVertical && config.verticalColumnOrder === 'rtl') {
  items.forEach(item => {
    // 假设 item.col 存储了逻辑列号
    // 或者根据 x 坐标反推：
    const logicCol = (item.x - paddingLeft) / cellWithGap;
    const visualCol = (totalCalculatedCols - 1) - logicCol;
    item.x = paddingLeft + visualCol * cellWithGap;
  });
}
```

**2️⃣ `src/components/PaperCanvas.vue`**
初始滚动到右侧：
```typescript
// 监听布局完成
watch(() => layoutConfig.value.isVertical, (isVertical) => {
  if (isVertical && layoutConfig.value.verticalColumnOrder === 'rtl') {
    nextTick(() => {
      if (containerRef.value) {
        containerRef.value.scrollLeft = containerRef.value.scrollWidth;
      }
    });
  }
});
```

---

## ✅ 验证标准

1.  **排版方向**:
    - 切换为竖排后，文字从上往下读。
    - 列从右往左增加 (RTL)。
2.  **滚动行为**:
    - 竖排模式下，页面初始位于最右侧。
    - 鼠标滚轮（配合 Shift 或触摸板）横向滚动正常。
3.  **动态响应**:
    - 竖排模式下调整窗口高度，行数（每列字数）应自动调整。
